<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Peli-Tracking</title>

  <!-- Manifest + couleur barre -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#E97132" />

  <!-- Favicon/icone (aide Android Ã  capter lâ€™icone) -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- Styles versionnÃ©s -->
  <link rel="stylesheet" href="style.css?v=11" />
</head>
<body>
  <header>
    <img src="pelichet_logo.jpg" alt="Pelichet Logo" />
    <h1>Peli-Tracking</h1>

    <!-- Bouton "Installer" affichÃ© si PWA Ã©ligible -->
    <button id="installBtn" style="margin-left:auto;display:none;">ğŸ“² Installer</button>
  </header>

  <!-- Boutons rapides -->
  <div class="quick-actions">
    <button class="quick in"  onclick="punchIn()">ğŸ‘‰ Pointer arrivÃ©e</button>
    <button class="quick out" onclick="punchOut()">ğŸ‘‹ Pointer dÃ©part</button>
  </div>

  <!-- Saisie manuelle -->
  <div class="controls">
    <label for="date">Date :</label>
    <input type="date" id="date" />

    <label for="arrival">Heure dâ€™arrivÃ©e :</label>
    <input type="time" id="arrival" />

    <label for="departure">Heure de dÃ©part :</label>
    <input type="time" id="departure" />

    <button onclick="saveHours()">Enregistrer</button>
  </div>

  <!-- Semaine -->
  <section id="historySection">
    <h2>ğŸ“Š Historique de la semaine</h2>
    <div id="weeklyTotal"></div>
    <div id="history"></div>
  </section>

  <!-- Mois -->
  <section id="monthSection">
    <h2>ğŸ“… Historique du mois</h2>
    <label for="monthSelect">Mois :</label>
    <select id="monthSelect" onchange="renderMonth()"></select>
    <div id="monthlyTotal"></div>
    <div id="monthlyHistory"></div>

    <div id="totalsAboveChart"></div>
    <canvas id="chartCanvas" width="900" height="420"></canvas>
    <div id="totalsBelowChart"></div>
  </section>

  <!-- AnnÃ©e -->
  <section id="yearSection">
    <h2>ğŸ—“ï¸ Historique de lâ€™annÃ©e</h2>
    <div id="annualTotal"></div>
    <div id="yearHistory"></div>
  </section>

  <!-- Export/Import -->
  <section style="padding:0 20px 30px;">
    <button onclick="exportCSV()">ğŸ“¤ Exporter CSV</button>
    <input type="file" accept=".csv" onchange="importCSV(event)" />
  </section>

  <!-- Toast -->
  <div id="flash" class="toast" role="status" aria-live="polite"></div>

  <!-- DIAGNOSTIC PWA -->
  <section id="pwaDiag" style="margin:18px 20px; padding:12px; border:1px dashed #ccc; border-radius:10px;">
    <h3>ğŸ”§ Diagnostic PWA</h3>
    <div id="diagContent">Chargementâ€¦</div>
    <button id="resetPwaBtn" style="margin-top:10px;">â™»ï¸ RÃ©initialiser le cache PWA (sans effacer mes heures)</button>
  </section>

  <!-- Lib chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- App -->
  <script src="script.js?v=11"></script>

  <!-- Service Worker (scope GitHub Pages) + bouton Installer + Diag -->
  <script>
    // Enregistre le SW sous le bon scope (/Peli-Tracking/)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/Peli-Tracking/sw.js', { scope: '/Peli-Tracking/' })
        .then(r => console.log('SW OK scope =', r.scope))
        .catch(console.error);
    }

    // Bouton dâ€™installation forcÃ© via beforeinstallprompt
    let deferredPrompt = null;
    const installBtn = document.getElementById('installBtn');

    // Masquer si dÃ©jÃ  en standalone
    if (window.matchMedia('(display-mode: standalone)').matches || navigator.standalone) {
      installBtn.style.display = 'none';
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      const p = deferredPrompt;
      deferredPrompt = null;
      await p.prompt();
      installBtn.style.display='none';
    });

    window.addEventListener('appinstalled', () => {
      installBtn.style.display='none';
      console.log('PWA installÃ©e ğŸ‰');
    });

    // === DIAGNOSTIC PWA ===
    async function diag() {
      const hasSW = !!(navigator.serviceWorker && navigator.serviceWorker.controller);
      const modeStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;
      const manifestResp = await fetch('manifest.webmanifest', {cache:'no-cache'}).then(r => ({ok:r.ok, type:r.headers.get('content-type')})).catch(()=>({ok:false,type:'-'}));
      const diagDiv = document.getElementById('diagContent');
      diagDiv.innerHTML = `
        URL: <code>${location.href}</code><br>
        Mode dâ€™affichage: <b>${modeStandalone ? 'standalone (OK, pas de barre URL si lancÃ© depuis icÃ´ne)' : 'navigateur'}</b><br>
        Service Worker contrÃ´leur: <b>${hasSW ? 'OUI' : 'NON'}</b><br>
        Manifest chargÃ©: <b>${manifestResp.ok ? 'OUI' : 'NON'}</b> (type=${manifestResp.type || 'n/a'})<br>
        beforeinstallprompt capturÃ©: <b>${deferredPrompt ? 'OUI' : 'NON'}</b><br>
      `;
    }
    diag();

    // Bouton reset PWA (nâ€™efface PAS localStorage)
    document.getElementById('resetPwaBtn').addEventListener('click', async ()=>{
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if ('caches' in window) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
        alert('Caches PWA et SW rÃ©initialisÃ©s. Recharge la page 2 fois, puis rÃ©installe.');
        location.reload(true);
      } catch(e){ alert('Reset erreur: ' + e); }
    });
  </script>
</body>
</html>
